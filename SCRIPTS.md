# Optional scripts

Add this script to `.bashrc`, `.bash_profile`, or an analogous file for your shell. After adding the script, source the file with `source /path/to/file`. 

These haven't been tested on Windows, and probably would not work unless you use Git Bash or WSL.

## Preserving shell history

The default installation spawns a subshell which doesn't share the previous process's history. To preserve the history, use this script. It also bypasses the wrapper for commands that should print directly to the terminal (like `install` and `completions`). 

```bash
# sb shell function to preserve history after switching directory
sb() {
  # Bypass wrapper for commands that must print directly
  case "$1" in
    install|-h|--help|completions)
      command sb "$@"
      return
      ;;
  esac

  # Capture both stdout and stderr safely (no process substitution)
  local out status
  out=$(SB_SHELL_WRAPPER=1 command sb "$@" 2>&1)
  status=$?

  # Print any non-protocol lines to stderr with prefix so they're visible
  printf "%s\n" "$out" | grep -vE '^(DIR:|BRANCH:)' | sed 's/^/[sb]/' 1>&2

  # If sb failed, bubble up the failure
  if [ $status -ne 0 ]; then
    return $status
  fi

  # Extract protocol lines
  local dir branch
  dir=$(printf "%s\n" "$out" | grep '^DIR:' | tail -n1 | cut -d: -f2- | xargs)
  branch=$(printf "%s\n" "$out" | grep '^BRANCH:' | tail -n1 | cut -d: -f2- | xargs)

  if [ -z "$dir" ]; then
    echo "[sb] No DIR in output; nothing to do" 1>&2
    return 1
  fi

  # Change directory; report failure
  if ! cd "$dir"; then
    echo "[sb] Failed to cd to $dir" 1>&2
    return 1
  fi

  if [ -n "$branch" ]; then
    if ! git checkout "$branch"; then
      echo "[sb] git checkout $branch failed" 1>&2
      return 1
    fi
  fi
}
```

## Completions

Completions can be generated by the following script.

```bash
# _sb_complete generates shell completions for sb (aliases)
_sb_complete() {
  local cur aliases
  cur="${COMP_WORDS[COMP_CWORD]}"
  # Use `command sb` to bypass the shell function wrapper
  aliases=$(command sb completions)
  COMPREPLY=( $(compgen -W "${aliases}" -- ${cur}) )
}
complete -F _sb_complete sb
```